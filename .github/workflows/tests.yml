name: "Tests"

on: [pull_request]

jobs:
  tests:
    name: Unit & E2E (PHP ${{ matrix.php_version }})
    runs-on: ubuntu-latest

    strategy:
      matrix:
        php_version: ['8.0', '8.1', '8.2']
      fail-fast: false  # this makes sure all versions are tested even if one fails

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 2
        submodules: recursive

    - run: git checkout HEAD^2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build image
      uses: docker/build-push-action@v3
      with:
        context: .
        push: false
        tags: database-dev-${{ matrix.php_version }}
        load: true
        cache-from: type=gha
        cache-to: type=gha,mode=max

    # Assuming you have Dockerfiles named like Dockerfile-7.4, Dockerfile-8.0, etc.
    # This step chooses the correct Dockerfile based on PHP version
    - name: Choose Dockerfile
      run: echo "DOCKERFILE=Dockerfile-${{ matrix.php_version }}" >> $GITHUB_ENV

    - name: Start Databases
      run:  |
        docker compose -f $DOCKERFILE up -d
        sleep 10

    - name: Run Tests
      run: docker compose exec -T tests vendor/bin/phpunit --configuration phpunit.xml

    - name: Check Coverage
      run: docker compose exec -T tests vendor/bin/coverage-check tmp/clover.xml 90
