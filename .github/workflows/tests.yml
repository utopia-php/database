name: "Tests"

on: [pull_request]
jobs:
  tests:
    name: Unit & E2E
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 2
        submodules: recursive

    - run: git checkout HEAD^2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build image (8.0)
      uses: docker/build-push-action@v3
      with:
        context: .
        file: ./Dockerfile-8.0
        push: false
        tags: database-80
        load: true
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build image (8.1)
      uses: docker/build-push-action@v3
      with:
        context: .
        file: ./Dockerfile-8.1
        push: false
        tags: database-81
        load: true
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build image (8.2)
      uses: docker/build-push-action@v3
      with:
        context: .
        file: ./Dockerfile-8.2
        push: false
        tags: database-82
        load: true
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Start Databases
      run:  |
        docker compose up -d
        sleep 10

    - name: Run Tests (PHP 8.0)
      run: docker compose exec -T tests80 vendor/bin/phpunit --configuration phpunit.xml

    - name: Run Tests (PHP 8.1)
      run: docker compose exec -T tests81 vendor/bin/phpunit --configuration phpunit.xml

    - name: Run Tests (PHP 8.2)
      run: docker compose exec -T tests82 vendor/bin/phpunit --configuration phpunit.xml

    - name: Check Coverage
      run: docker compose exec -T tests vendor/bin/coverage-check tmp/clover.xml 90
